# TrustyConvert API Specification

## Overview

TrustyConvert is a secure file conversion service that allows users to convert files between various formats. The API follows RESTful principles and uses a session-based authentication system with CSRF protection.

## Base URL

```
https://api.trustyconvert.com/api
```

For production deployments, the API will be hosted on a separate domain from the frontend. CORS is configured to allow cross-origin requests with credentials.

## Authentication

The API uses session-based authentication with secure cookies and CSRF tokens:

1. Sessions are managed through HTTP-only cookies
2. CSRF protection is implemented using tokens that must be included in headers
3. All requests requiring authentication must include both the session cookie and CSRF token

## API Endpoints

### Session Management

#### Create Session

```
POST /session
```

Initializes a new session and returns a CSRF token.

**Request:**
- No body required

**Response:**
```json
{
  "success": true,
  "data": {
    "csrf_token": "your-csrf-token"
  },
  "correlation_id": "unique-correlation-id"
}
```

**Implementation Notes:**
- Store the CSRF token in your frontend state
- Include this token in the `X-CSRF-Token` header for all subsequent requests
- The session cookie will be automatically set by the browser

#### Close Session

```
POST /session/close
```

Closes the current session and cleans up associated resources.

**Request Headers:**
- `X-CSRF-Token`: CSRF token from session creation

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "Session closed and cleaned up."
  },
  "correlation_id": "unique-correlation-id"
}
```

### File Operations

#### Upload File

```
POST /upload
```

Uploads a file for conversion.

**Request:**
- Content-Type: `multipart/form-data`
- Fields:
  - `file`: The file to upload
  - `job_id`: A client-generated UUID to track this job
- Headers:
  - `X-CSRF-Token`: CSRF token from session creation

**Response:**
```json
{
  "success": true,
  "data": {
    "job_id": "client-generated-uuid",
    "status": "uploaded"
  },
  "correlation_id": "unique-correlation-id"
}
```

**Implementation Notes:**
- The job_id should be a valid UUID4 generated by the client
- Maximum file size: 100MB (configurable)
- Files are validated for format and scanned for viruses

#### Convert File

```
POST /convert
```

Initiates conversion of a previously uploaded file.

**Request:**
- Content-Type: `application/json`
- Headers:
  - `X-CSRF-Token`: CSRF token from session creation
- Body:
```json
{
  "job_id": "client-generated-uuid",
  "target_format": "pdf"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "job_id": "client-generated-uuid",
    "task_id": "server-generated-task-id",
    "status": "processing"
  },
  "correlation_id": "unique-correlation-id"
}
```

**Implementation Notes:**
- The job_id must match a previously uploaded file
- The target_format must be supported for the source file format

#### Check Job Status

```
GET /job_status?job_id=client-generated-uuid
```

Checks the status of a conversion job.

**Request:**
- Query Parameters:
  - `job_id`: The client-generated UUID for the job

**Response:**
```json
{
  "success": true,
  "data": {
    "job_id": "client-generated-uuid",
    "status": "completed",
    "original_filename": "document.docx",
    "created_at": "2023-01-01T12:00:00Z",
    "updated_at": "2023-01-01T12:01:30Z",
    "output_size": 123456,
    "completed_at": "2023-01-01T12:01:30Z",
    "conversion_time": 1.5
  },
  "correlation_id": "unique-correlation-id"
}
```

**Possible Status Values:**
- `uploaded`: File has been uploaded but conversion not started
- `queued`: Conversion job is queued
- `processing`: Conversion is in progress
- `converting`: Active conversion phase
- `completed`: Conversion completed successfully
- `failed`: Conversion failed

#### Create Download Token

```
POST /download_token
```

Creates a short-lived token to download the converted file.

**Request:**
- Content-Type: `application/json`
- Headers:
  - `X-CSRF-Token`: CSRF token from session creation
- Body:
```json
{
  "job_id": "client-generated-uuid"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "download_token": "download-token-value"
  },
  "correlation_id": "unique-correlation-id"
}
```

**Implementation Notes:**
- Download tokens are valid for 10 minutes
- Tokens can only be used once
- Job must be in "completed" status to generate a token

#### Download Converted File

```
GET /download?token=download-token-value
```

Downloads the converted file using a previously generated token.

**Request:**
- Query Parameters:
  - `token`: The download token from the create_download_token endpoint

**Response:**
- The file will be downloaded directly
- Headers:
  - `Content-Disposition`: attachment; filename="converted-file.pdf"
  - `Content-Type`: Appropriate MIME type for the file
  - `Content-Length`: File size in bytes

**Implementation Notes:**
- The download token is consumed upon use
- The session cookie must still be present

### Health Check

#### Health Check

```
GET /health
```

Checks if the API is running.

**Response:**
```json
{
  "success": true,
  "data": {
    "status": "ok"
  },
  "correlation_id": "unique-correlation-id"
}
```

## Supported Conversions

The API supports the following conversion formats:

### Document Formats
- Word Processing: docx, odt, rtf, txt → pdf, docx, odt, html, txt
- Spreadsheets: xlsx, ods, csv → pdf, xlsx, ods, csv, html
- Presentations: pptx, odp → pdf, pptx, odp, html
- PDF: pdf → txt, png, jpg, jpeg, html, docx

### Image Formats
- jpg/jpeg → png, bmp, tiff, gif, webp, pdf
- png → jpg, jpeg, bmp, tiff, gif, webp, pdf
- bmp → jpg, jpeg, png, tiff, gif, webp, pdf
- tiff → jpg, jpeg, png, bmp, gif, webp, pdf
- gif → jpg, jpeg, png, bmp, tiff, webp, pdf
- webp → jpg, jpeg, png, bmp, tiff, gif, pdf

## Error Handling

All errors follow a consistent format:

```json
{
  "success": false,
  "data": {
    "error": "ErrorType",
    "message": "Human-readable error message",
    "correlation_id": "unique-correlation-id",
    "details": {} // Optional additional details
  }
}
```

### Common Error Types

- `ValidationError`: Invalid input data
- `FileValidationError`: File format or content issues
- `SessionValidationError`: Invalid or expired session
- `CSRFValidationError`: Missing or invalid CSRF token
- `ResourceNotFound`: Requested resource not found
- `RateLimitExceeded`: Too many requests
- `VirusDetectedError`: Security threat detected
- `MaxFileSizeExceededError`: File too large
- `UnsupportedFormatError`: Conversion not supported
- `ServerError`: Internal server error

## Rate Limiting

The API implements rate limiting to prevent abuse:

- `/convert`: 10 requests per minute
- `/download`: 30 requests per minute
- `/upload`: 5 requests per minute

When rate limits are exceeded, a 429 status code is returned with a `Retry-After` header.

## Cross-Origin Resource Sharing (CORS)

For production deployments where the API is on a different domain than the frontend:

- Credentials (cookies) are allowed with `withCredentials: true`
- The frontend domain must be whitelisted in the API configuration
- SameSite cookie attribute is set to "none" to allow cross-site requests
- Secure flag is enabled on all cookies

## Implementation Guide for Frontend

### Session Management Flow

1. **Initialize Session**:
   ```javascript
   async function initSession() {
     const response = await fetch('https://api.trustyconvert.com/api/session', {
       method: 'POST',
       credentials: 'include' // Important for cookies
     });
     const data = await response.json();
     if (data.success) {
       // Store CSRF token for future requests
       localStorage.setItem('csrfToken', data.data.csrf_token);
     }
     return data;
   }
   ```

2. **Include CSRF Token in Requests**:
   ```javascript
   const csrfToken = localStorage.getItem('csrfToken');
   const headers = {
     'X-CSRF-Token': csrfToken,
     'Content-Type': 'application/json'
   };
   ```

### File Conversion Flow

1. **Upload File**:
   ```javascript
   async function uploadFile(file) {
     const jobId = generateUUID(); // Generate UUID4
     const formData = new FormData();
     formData.append('file', file);
     formData.append('job_id', jobId);
     
     const response = await fetch('https://api.trustyconvert.com/api/upload', {
       method: 'POST',
       headers: {
         'X-CSRF-Token': csrfToken
       },
       credentials: 'include',
       body: formData
     });
     
     return await response.json();
   }
   ```

2. **Convert File**:
   ```javascript
   async function convertFile(jobId, targetFormat) {
     const response = await fetch('https://api.trustyconvert.com/api/convert', {
       method: 'POST',
       headers: {
         'X-CSRF-Token': csrfToken,
         'Content-Type': 'application/json'
       },
       credentials: 'include',
       body: JSON.stringify({
         job_id: jobId,
         target_format: targetFormat
       })
     });
     
     return await response.json();
   }
   ```

3. **Poll Job Status**:
   ```javascript
   async function checkJobStatus(jobId) {
     const response = await fetch(`https://api.trustyconvert.com/api/job_status?job_id=${jobId}`, {
       method: 'GET',
       credentials: 'include'
     });
     
     return await response.json();
   }
   
   // Poll every 2 seconds
   function pollJobStatus(jobId) {
     const intervalId = setInterval(async () => {
       const result = await checkJobStatus(jobId);
       
       if (result.success) {
         const status = result.data.status;
         
         if (status === 'completed' || status === 'failed') {
           clearInterval(intervalId);
           // Handle completion or failure
         }
       }
     }, 2000);
   }
   ```

4. **Download File**:
   ```javascript
   async function getDownloadToken(jobId) {
     const response = await fetch('https://api.trustyconvert.com/api/download_token', {
       method: 'POST',
       headers: {
         'X-CSRF-Token': csrfToken,
         'Content-Type': 'application/json'
       },
       credentials: 'include',
       body: JSON.stringify({ job_id: jobId })
     });
     
     return await response.json();
   }
   
   function downloadFile(token) {
     // Redirect browser to download URL
     window.location.href = `https://api.trustyconvert.com/api/download?token=${token}`;
   }
   ```

## Security Considerations

1. **Always use HTTPS** for all API communications
2. **Store CSRF tokens securely** in memory or sessionStorage (not localStorage for production)
3. **Validate all user inputs** before sending to the API
4. **Handle session expiration** gracefully by redirecting to login/session creation
5. **Implement proper error handling** for all API responses
6. **Set appropriate Content Security Policy** headers in your frontend

## Production Deployment Notes

When deploying to production with the API on a separate domain:

1. Configure the API's CORS settings to allow your frontend domain:
   ```
   CORS_ORIGIN_WHITELIST=https://your-frontend-domain.com
   ```

2. Ensure all frontend requests include credentials:
   ```javascript
   fetch(url, {
     credentials: 'include',
     // other options
   });
   ```

3. The API uses secure cookies with SameSite=None to work across domains:
   ```
   SESSION_COOKIE_PARAMS = {
     "httponly": True,
     "secure": True,
     "samesite": "none",
     "max_age": SESSION_LIFETIME,
     "path": "/",
   }
   ```

4. Consider implementing a health check in your frontend to verify API availability before user interaction 